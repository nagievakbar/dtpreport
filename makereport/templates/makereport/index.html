{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <title>Отчёты</title>
    <meta content="" name="description">
    <meta content="" name="keywords">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
          rel="stylesheet">
    <link href="{% static 'vendor/bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
    <link href="{% static 'vendor/icofont/icofont.min.css' %}" rel="stylesheet">

    <!-- Template Main CSS File -->
    <link rel="stylesheet" href="{% static '/makereport/css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static '/makereport/css/fontawsom-all.min.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static '/makereport/css/main.css' %}"/>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
          crossorigin="anonymous">
    <link rel='stylesheet' href='https://s3-us-west-2.amazonaws.com/s.cdpn.io/123941/tablesaw.stackonly.css'>
    <script src="{% static '/makereport/js/jquery-1.12.4.js' %}"></script>
    <script src="{% static '/makereport/js/desktop6.js' %}"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
    <script src='https://s3-us-west-2.amazonaws.com/s.cdpn.io/162656/tablesaw.stackonly.js'></script>
    <script src="https://unpkg.com/ionicons@5.2.3/dist/ionicons.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
    <script src="{% static '/makereport/js/e-imzo.js' %}" type="text/javascript"></script>
    <script src="{% static '/makereport/js/e-imzo-client.js' %}" type="text/javascript"></script>
    {#        <script src="{% static '/makereport/js/bootstrap.min.js' %}" type="text/javascript"></script>#}
    {#        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>#}
    <link rel="stylesheet" type="text/css" href="{% static '/makereport/css/modal.css' %}"/>
    {% comment %} <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous"> {% endcomment %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js"
            integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh"
            crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js"
            integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0"
            crossorigin="anonymous"></script>
    <style>

        .inline_button {
            white-space: nowrap;
            margin-top: 4px;
        }

        .inline_button button {
            display: inline-block;
            white-space: normal;
            width: 80px;
            height: 30px;
            padding: 0px;
            font-size: 12px;
        }

        button, input[type="button"] {
            background: none;
            color: #5c6e91;
            border: none;
            padding: 0;
            font: inherit;
            cursor: pointer;
            outline: inherit;
        }

        input[type="button"]:active {
            background: none;
            color: #5c6e91;
            border: none;
            padding: 0;
            font: inherit;
            cursor: pointer;
            outline: inherit;
        }

        input[type="button"]:focus {
            background: none;
            color: #5c6e91;
            border: none;
            padding: 0;
            font: inherit;
            cursor: pointer;
            outline: inherit;
        }

        input[type="button"]:after {
            background: none;
            color: #5c6e91;
            border: none;
            padding: 0;
            font: inherit;
            cursor: pointer;
            outline: inherit;
        }
    </style>
</head>

<body>

<!-- ======= Mobile nav toggle button ======= -->
<button type="button" class="mobile-nav-toggle d-xl-none"><i class="icofont-navigation-menu"></i></button>

<!-- ======= Header ======= -->
{% include 'makereport/header/left_navbar.html' with reports="active" %}


<main id="main">

    <!-- ======= Header ======= -->
    <div class="header-top">
        <div class="container">

            <nav class="new-document-part">
                <ul>
                    <li><a href="{% url 'new_report' %}" class="new-document-btn">Новый документ</a></li>
                </ul>
            </nav>

            <nav class="user-profile-part">
                <ul>
                    <li class="img-user-profile"><img src="{% static '/makereport/img/user.png' %}"></li>
                    <li class="user-name-btn"><a href="#">{{ user.username }}</a></li>
                    <li><a href="{% url 'user_logout' %}" class="log-out-btn">Выйти</a></li>
                </ul>
            </nav>

        </div>
    </div>
    <!-- ======= Header ======= -->

    {% include 'makereport/header/header.html' %}


    <div class="table1">
        <table class="table" data-tablesaw-mode="stack">

            <thead>
            <tr>
                <th style="width: 34px;">№</th>
                <th style="width: 136px;">Номер отчета</th>
                <th style="width: 136px;">Марка машины</th>
                <th style="width: 136px;">Номер</th>
                <th style="width: 136px;">Исполнитель</th>
                {#              <th style="width: 136px;">Договор</th>#}
                <th style="width: 136px;">Ключ</th>
                <th style="width: 136px;">Дата</th>
                <th style="width: 159px;">Функции</th>
            </tr>
            </thead>
            <tbody>
            {% for report in reports %}
                <tr id="{{ report.report_id }}">
                    <td style="border-bottom: 1px solid #fff;" data-title="№">{{ report.report_id }}</td>
                    {#                  <td style="border-bottom: 1px solid #fff;" data-title="Дата">{{ report.created_at|date:"d.m.Y" }}</td>#}
                    <td style="border-bottom: 1px solid #fff;"
                        data-title="Дата">{{ report.report_number }}</td>
                    <td style="border-bottom: 1px solid #fff;"
                        data-title="Марка машины">{{ report.car.brand_text }}</td>
                    <td style="border-bottom: 1px solid #fff;" data-title="Номер">{{ report.car.car_number }}</td>
                    <td style="border-bottom: 1px solid #fff;"
                        data-title="Исполнитель">{{ report.created_by }}</td>
                    {#                  <td style="border-bottom: 1px solid #fff;" data-title="Договор">{{ report.contract }}</td>#}
                    <td style="border-bottom: 1px solid #fff;" data-title="Ключ">{{ report.key }}</td>
                    <td style="border-bottom: 1px solid #fff;" data-title="Отчет">{{ report.report_date }}</td>
                    <td style="border-bottom: 1px solid #fff;" data-title="Функции" data-type="currency">
                        {% if report.type_report == 3 %}
                            <a href="{% url 'disposable_view_edit' report.report_id %}">Изменить</a>
                        {% elif report.type_report == 2 %}
                            <a href="{% url 'enumeration_view_edit' report.report_id %}">Изменить</a>
                        {% else %}
                            <a href="{% url 'edit_report' report.report_id %}">Изменить</a>
                        {% endif %}
                        <button class="delete-report" type="button" id_report="{{ report.report_id }}"
                                data-toggle="modal" data-target="#exampleModal">Удалить
                        </button>
                        {#                            <a href="#" data-toggle="modal" data-target="#deleteModal" data-bs-whatever="{{ report.report_id }}">Удалить</a>#}
                    </td>
                </tr>

            {% endfor %}

            </tbody>
        </table>
    </div>

    {% include 'makereport/pagination/pagination.html' %}


    <svg class="liquid_shape_first" width="302" height="261" viewBox="0 0 302 261" fill="none"
         xmlns="http://www.w3.org/2000/svg">
        <path opacity="0.1"
              d="M270.752 -179.869C335.462 -170.06 413.703 -182.881 453.096 -130.674C492.522 -78.4224 459.489 -6.66316 450.329 58.1232C441.133 123.161 452.701 201.032 400.542 241.033C348.193 281.179 275.687 249.581 210.084 242.367C140.593 234.724 52.4779 256.191 13.1867 198.433C-25.9933 140.838 33.4778 68.6878 45.2454 0.0547791C56.3985 -64.9946 27.7037 -146.142 79.3285 -187.332C131.195 -228.714 205.12 -189.818 270.752 -179.869Z"
              fill="#5C6E91"/>
        <path opacity="0.1"
              d="M266.187 -152.282C322.397 -143.754 390.361 -154.901 424.579 -109.513C458.827 -64.0867 430.132 -1.70074 422.175 54.6232C414.188 111.165 424.236 178.865 378.929 213.641C333.456 248.543 270.474 221.073 213.488 214.801C153.125 208.157 76.5846 226.819 42.4545 176.606C8.42104 126.534 60.0803 63.8078 70.3021 4.13969C79.9902 -52.4129 55.0647 -122.961 99.9082 -158.77C144.962 -194.747 209.177 -160.932 266.187 -152.282Z"
              fill="#5C6E91"/>
    </svg>

    <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">

                <div class="modal-body">
                    <form name=testform>
                        <div class="container-fluid">
                            <div class="col-md-6">
                                <label id="message"></label>
                                Введите пароль<br/>
                                <input type="number" id="report_unique_id" style="display: none">
                                <input id="password_input" class="form-control" type="password">

                                {# style="display: none" #}
                            </div>
                        </div>
                    </form>
                </div>
                <br>
                <div class="modal-footer">
                    <button onclick="delete_report()" type="button" class="btn btn-primary btn-link sign">Удалить
                    </button>
                </div>
            </div>
        </div>
    </div>

    {#<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">#}
    {#  <div class="modal-dialog" role="document">#}
    {#    <div class="modal-content">#}
    {#      <div class="modal-header">#}
    {#        <h5 class="modal-title" id="exampleModalLabel">Удаление отчёта</h5>#}
    {#        <button type="button" class="btn-close" data-dismiss="modal" aria-label="Close">#}
    {#          <span aria-hidden="true">&times;</span>#}
    {#        </button>#}
    {#      </div>#}
    {#      <div class="modal-body">#}
    {#        <form name=testform>#}
    {#            <div class="container-fluid">#}
    {#                <h3>Вы хотите удалить отчёт?</h3>#}
    {#            </div>#}
    {#        </form>#}
    {#      </div>#}
    {#      <div class="modal-footer">#}
    {#        <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>#}
    {#        <button type="button" class="btn btn-primary deleteButton">Удалить</button>#}
    {#      </div>#}
    {#    </div>#}
    {#  </div>#}
    {#</div>#}

</main>


</body>
<script>
    var csrftoken = jQuery("[name=csrfmiddlewaretoken]").val();
    $(".delete-report").on('click', function () {
        let sign = $(this).attr('id_report');
        let model = $("#exampleModal").find("#report_unique_id");
        console.log(sign)
        model.val(sign)
    })

    function delete_report() {
        var password = "123Aa123_"
        var entered_password = $("#password_input").val()
        if (password === entered_password) {
            var id = $("#report_unique_id").val()
            console.log(id)
            myFunction(id)
        } else {
            $("#exampleModal").modal('hide');
            alert("Не правильный пароль!!!")
        }
    }

    function makePdf(id) {
        if (id) {
            $.ajax({
                type: "GET",
                headers: {
                    "X-CSRFToken": csrftoken
                },
                url: `{% url "make_pdf" %}?id=${id}`,
                success: function (data) {
                    alert("Вы успешно добавили в pdf!");

                },
                error: function (xhr, ajaxOptions, thrownError) {
                    console.log(xhr)
                    console.log(ajaxOptions)
                    console.log(thrownError)
                    console.log("error")
                }
            })
        }
    }

    function myFunction(id) {
        var txt;
        console.log(id);
        if (confirm("Вы точно хотите удалить")) {
            $.ajax({
                type: "GET",
                headers: {
                    "X-CSRFToken": csrftoken
                },
                url: `{% url "delete_report"%}?id=${id}`,
                success: function (data) {
                    $("#exampleModal").modal('hide');
                    alert("Вы успешно удалили!");
                    $(`#${id}`).remove();

                },
                error: function (xhr, ajaxOptions, thrownError) {
                    console.log(xhr)
                    console.log(ajaxOptions)
                    console.log(thrownError)
                    console.log("error")
                }
            })
        } else {
            txt = "You pressed Cancel!";
        }
    }

</script>
{% block javascript %}
    <script>

        var exampleModal = document.getElementById('exampleModal')
        exampleModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var recipient = "";
            var sign = button.getAttribute('sign');
            var sign_from = button.getAttribute('sign_from');
            exampleModal.querySelector('.sign').value = sign;
            exampleModal.querySelector('#sign_from').value = sign_from;
            console.log('Check')
            console.log(sign[0])
            console.log(sign[0] === 'T')
            if (sign[0] === 'T') {
                recipient = button.getAttribute('pkcs7');
            } else {
                console.log('get this')
            }
            recipient = button.getAttribute('data-bs-whatever');
            var report_id = button.getAttribute('data-bs-report');

            var modalFileInput = exampleModal.querySelector('.file');
            var modalReportIdField = exampleModal.querySelector('.report_id');

            modalFileInput.textContent = recipient
            modalReportIdField.value = report_id
        })

        $('#exampleModal').on('hidden.bs.modal', function (e) {
            location.reload();
        })

        $(document).on('click', ".btn btn-primary sign", function (e) {
            console.log('CLICK sign')
            var pkcs7 = $(this).parents('.modal-body').find('.pkcs7').textContent;
            console.log(pkcs7)
        });

        var EIMZO_MAJOR = 3;
        var EIMZO_MINOR = 37;


        var errorCAPIWS = 'Ошибка соединения с E-IMZO. Возможно у вас не установлен модуль E-IMZO или Браузер E-IMZO.';
        var errorBrowserWS = 'Браузер не поддерживает технологию WebSocket. Установите последнюю версию браузера.';
        var errorUpdateApp = 'ВНИМАНИЕ !!! Установите новую версию приложения E-IMZO или Браузера E-IMZO.<br /><a href="https://e-imzo.uz/main/downloads/" role="button">Скачать ПО E-IMZO</a>';
        var errorWrongPassword = 'Пароль неверный.';


        var AppLoad = function () {
            EIMZOClient.API_KEYS = [
                'localhost', '96D0C1491615C82B9A54D9989779DF825B690748224C2B04F500F370D51827CE2644D8D4A82C18184D73AB8530BB8ED537269603F61DB0D03D2104ABF789970B',
                '127.0.0.1', 'A7BCFA5D490B351BE0754130DF03A068F855DB4333D43921125B9CF2670EF6A40370C646B90401955E1F7BC9CDBF59CE0B2C5467D820BE189C845D0B79CFC96F',
                'null', 'E0A205EC4E7B78BBB56AFF83A733A1BB9FD39D562E67978CC5E7D73B0951DB1954595A20672A63332535E13CC6EC1E1FC8857BB09E0855D7E76E411B6FA16E9D',
                'dls.yt.uz', 'EDC1D4AB5B02066FB3FEB9382DE6A7F8CBD095E46474B07568BC44C8DAE27B3893E75B79280EA82A38AD42D10EA0D600E6CE7E89D1629221E4363E2D78650516'
            ];
            uiLoading();
            EIMZOClient.checkVersion(function (major, minor) {
                var newVersion = EIMZO_MAJOR * 100 + EIMZO_MINOR;
                var installedVersion = parseInt(major) * 100 + parseInt(minor);
                if (installedVersion < newVersion) {
                    uiUpdateApp();
                } else {
                    EIMZOClient.installApiKeys(function () {
                        uiLoadKeys();
                    }, function (e, r) {
                        if (r) {
                            uiShowMessage(r);
                        } else {
                            wsError(e);
                        }
                    });
                }
            }, function (e, r) {
                if (r) {
                    uiShowMessage(r);
                } else {
                    uiNotLoaded(e);
                }
            });
        }


        var uiShowMessage = function (message) {
            alert(message);
        }

        var uiLoading = function () {
            var l = document.getElementById('message');
            l.innerHTML = 'Загрузка ...';
            l.style.color = 'red';
        }

        var uiNotLoaded = function (e) {
            var l = document.getElementById('message');
            l.innerHTML = '';
            if (e) {
                wsError(e);
            } else {
                uiShowMessage(errorBrowserWS);
            }
        }

        var uiUpdateApp = function () {
            var l = document.getElementById('message');
            l.innerHTML = errorUpdateApp;
        }

        var uiLoadKeys = function () {
            uiClearCombo();
            EIMZOClient.listAllUserKeys(function (o, i) {
                var itemId = "itm-" + o.serialNumber + "-" + i;
                return itemId;
            }, function (itemId, v) {
                return uiCreateItem(itemId, v);
            }, function (items, firstId) {
                uiFillCombo(items);
                uiLoaded();
                uiComboSelect(firstId);
            }, function (e, r) {
                uiShowMessage(errorCAPIWS);
            });
        }

        var uiComboSelect = function (itm) {
            if (itm) {
                var id = document.getElementById(itm);
                id.setAttribute('selected', 'true');
            }
        }

        var cbChanged = function (c) {
            document.getElementById('keyId').innerHTML = '';
        }

        var uiClearCombo = function () {
            var combo = document.testform.key;
            combo.length = 0;
        }

        var uiFillCombo = function (items) {
            var combo = document.testform.key;
            for (var itm in items) {
                combo.append(items[itm]);
            }
        }

        var uiLoaded = function () {
            var l = document.getElementById('message');
            l.innerHTML = '';
        }

        var uiCreateItem = function (itmkey, vo) {
            var now = new Date();
            vo.expired = dates.compare(now, vo.validTo) > 0;
            var itm = document.createElement("option");
            itm.value = itmkey;
            itm.text = vo.CN;
            if (!vo.expired) {

            } else {
                itm.style.color = 'gray';
                itm.text = itm.text + ' (срок истек)';
            }
            itm.setAttribute('vo', JSON.stringify(vo));
            itm.setAttribute('id', itmkey);
            return itm;
        }

        var wsError = function (e) {
            if (e) {
                uiShowMessage(errorCAPIWS + " : " + e);
            } else {
                uiShowMessage(errorBrowserWS);
            }
        };

        verify = function () {
            var pkcs7 = document.testform.pkcs7.value;
            EIMZOClient.verifyPkcs7(pkcs7,)
        }

        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }


        sign_decide = function () {
            var choice = document.getElementById("sign").value;
            console.log('sign decide')
            console.log(choice)
            sign();
            if (choice[0] === "T") {
                adding_sign();
            } else {
            }
        }
        adding_sign = function () {
            var sign_from = document.getElementById('sign_from');

            var itm = document.testform.key.value;
            if (itm) {
                var id = document.getElementById(itm);
                var vo = JSON.parse(id.getAttribute('vo'));
                var data = document.testform.data.value;
                var keyId = document.getElementById('keyId').innerHTML;
                var report_input = document.getElementById('report_id');
                var sign_from = document.getElementById('sign_from');
                var pkcs7 = document.getElementsByClassName('file');
                console.log("in");
                console.log(keyId);
                if (keyId) {
                    EIMZOClient.append_pkcs7_attached(keyId, pkcs7, null, function (pkcs7) {
                        document.testform.pkcs7.value = pkcs7;
                        console.log("SUCESSS")
                        console.log("ADDDEDDD")
                        console.log('s')
                        $.ajax({
                            type: "POST",
                            headers: {
                                "X-CSRFToken": csrftoken
                            },
                            url: '{% url "verifyPkcs7" %}',
                            data: {
                                'pkcs7': pkcs7,
                                'sign_from': sign_from.value,
                                'report_id': report_input.value,
                                'csrfmiddlewaretoken':{% csrf_token %}
                            },
                            cache: true,
                            success: function (data) {
                                alert("Ваша подпись была успешна добавлена!")
                            },
                            error: function (xhr, ajaxOptions, thrownError) {
                                alert(xhr.status);
                                alert(thrownError);
                            }
                        })
                    }, function (e, r) {
                        if (r) {
                            if (r.indexOf("BadPaddingException") != -1) {
                                uiShowMessage(errorWrongPassword);
                            } else {
                                uiShowMessage(r);
                            }
                        } else {
                            document.getElementById('keyId').innerHTML = '';
                            console.log(e)
                            uiShowMessage(errorBrowserWS);
                        }
                        if (e) wsError(e);
                    });
                } else {
                    EIMZOClient.loadKey(vo, function (id) {
                        document.getElementById('keyId').innerHTML = id;
                        EIMZOClient.createPkcs7(id, data, null, function (pkcs7) {
                            document.testform.pkcs7.value = pkcs7;
                        }, function (e, r) {
                            if (r) {
                                if (r.indexOf("BadPaddingException") != -1) {
                                    uiShowMessage(errorWrongPassword);
                                } else {
                                    uiShowMessage(r);
                                }
                            } else {
                                document.getElementById('keyId').innerHTML = '';
                                uiShowMessage(errorBrowserWS);
                            }
                            if (e) wsError(e);
                            console.log(e)
                        });
                    }, function (e, r) {
                        if (r) {
                            if (r.indexOf("BadPaddingException") != -1) {
                                uiShowMessage(errorWrongPassword);
                            } else {
                                uiShowMessage(r);
                            }
                        } else {
                            uiShowMessage(errorBrowserWS);
                        }
                        if (e) wsError(e);

                    });
                }
            }
        }
        sign = function () {
            var sign_from = document.getElementById('sign_from');
            console.log(sign_from.value);
            console.log("sadsdsdasd");
            var itm = document.testform.key.value;
            if (itm) {
                var id = document.getElementById(itm);
                var vo = JSON.parse(id.getAttribute('vo'));
                var data = document.testform.data.value;
                var keyId = document.getElementById('keyId').innerHTML;
                var report_input = document.getElementById('report_id');
                var sign_from = document.getElementById('sign_from');
                if (keyId) {
                    EIMZOClient.createPkcs7(keyId, data, null, function (pkcs7) {
                        document.testform.pkcs7.value = pkcs7;
                        $.ajax({
                            type: "POST",
                            headers: {
                                "X-CSRFToken": csrftoken
                            },
                            url: '{% url "verifyPkcs7" %}',
                            data: {
                                'pkcs7': pkcs7,
                                'sign_from': sign_from.value,
                                'report_id': report_input.value,
                                'csrfmiddlewaretoken':{% csrf_token %}
                            },
                            cache: true,
                            success: function (data) {
                                alert("Вы успешно подписали документ!")
                            },
                        })
                    }, function (e, r) {
                        if (r) {
                            if (r.indexOf("BadPaddingException") != -1) {
                                uiShowMessage(errorWrongPassword);
                            } else {
                                uiShowMessage(r);
                            }
                        } else {
                            document.getElementById('keyId').innerHTML = '';
                            uiShowMessage(errorBrowserWS);
                        }
                        if (e) wsError(e);
                    });
                } else {
                    EIMZOClient.loadKey(vo, function (id) {
                        document.getElementById('keyId').innerHTML = id;
                        EIMZOClient.createPkcs7(id, data, null, function (pkcs7) {
                            document.testform.pkcs7.value = pkcs7;
                        }, function (e, r) {
                            if (r) {
                                if (r.indexOf("BadPaddingException") != -1) {
                                    uiShowMessage(errorWrongPassword);
                                } else {
                                    uiShowMessage(r);
                                }
                            } else {
                                document.getElementById('keyId').innerHTML = '';
                                uiShowMessage(errorBrowserWS);
                            }
                            if (e) wsError(e);
                        });
                    }, function (e, r) {
                        if (r) {
                            if (r.indexOf("BadPaddingException") != -1) {
                                uiShowMessage(errorWrongPassword);
                            } else {
                                uiShowMessage(r);
                            }
                        } else {
                            uiShowMessage(errorBrowserWS);
                        }
                        if (e) wsError(e);
                    });
                }
            }
        };

        window.onload = AppLoad;
    </script>

{% endblock %}

</html>